#Quarterly Report
#Select Quarter Only 
#Table will match what is in the quarterly report

#1.0 UI --------
  q_reportUI <- function(id, label = "q_report", current_fy, years){
    ns <- NS(id)
    tabPanel(title = "Quarterly Report", value = "q_report",
    fluidPage(#theme = shinytheme("cerulean"),
              titlePanel("Quarterly Report Counts"), 
              #1.1 General Inputs
              sidebarPanel(
                fluidRow(column(6, selectInput(ns("fy"), "Fiscal Year (FY)", choices = years)),
                         column(6, selectInput(ns("quarter"), "Quarter", choices = c("Q1", "Q2", "Q3", "Q4")))
                ),
              #1.2 Buttons
                fluidRow(column(12, actionButton(ns("table_button"), "Generate Table", style = "width: 123px;"))),
                fluidRow(column(12, br())),
                        #shinyjs::disabled(downloadButton(ns("postcon_qa"), "QA Queries", style = "width: 123px;")),
                        shinyjs::disabled(downloadButton(ns("public_postcon"), "Public Post-Construction Tables", style = "width: 300px;")),
                        shinyjs::disabled(downloadButton(ns("public_con"), "Public Construction Tables", style = "width: 300px;")),
                        shinyjs::disabled(downloadButton(ns("private_postcon"), "Private Post-Construction Tables", style = "width: 300px;"))
              
              
              
              
              ),
              #1.3 Main Panel (Outputs) -----
                mainPanel(
                  h4(textOutput(ns("header"))),
                  disabled(h4("Public Post-Construction")),
                  DTOutput(ns("pupc_table")), 
                  disabled(h4("Public Construction")), 
                  DTOutput(ns("puc_table")), 
                  disabled(h4("Private Post-Construction")), 
                  DTOutput(ns("prpc_table"))
                )
    )
    )
    
  }
  
#2.0 Server -----
  q_reportServer <- function(id, parent_session, current_fy, poolConn){
    moduleServer(
      id, 
      function(input, output, session){
        
        #2.1 set up----
        #define ns to use in modals
        ns <- session$ns
        
        #initialize reactive values
        rv <- reactiveValues()
        
        #create a date style for headers
        sf <- lubridate::stamp("March 1, 1999", orders = "%B %d, %Y")
        
        #get quarters as dates
        rv$start_quarter <- reactive(case_when(input$quarter == "Q3" ~ "1/1", 
                                               input$quarter == "Q4" ~ "4/1", 
                                               input$quarter == "Q1" ~ "7/1", 
                                               input$quarter == "Q2" ~ "10/1"))
        
        rv$end_quarter <- reactive(case_when(input$quarter == "Q3" ~ "3/31", 
                                             input$quarter == "Q4" ~ "6/30", 
                                             input$quarter == "Q1" ~ "9/30", 
                                             input$quarter == "Q2" ~ "12/31"))
        
        #creating a table to show exactly one quarter ahead of the one user selects for metric
        # rv$qa_quarter <- reactive(case_when(input$quarter == "Q1" ~ "Q2", 
        #                                      input$quarter == "Q2" ~ "Q3", 
        #                                      input$quarter == "Q3" ~ "Q4", 
        #                                      input$quarter == "Q4" ~ "Q1"))
        
        
        #convert FY/Quarter to a real date
        rv$start_date <- reactive(lubridate::mdy(paste0(rv$start_quarter(), "/", ifelse(input$quarter == "Q1" | input$quarter == "Q2", as.numeric(input$fy)-1,input$fy))))
        rv$end_date <- reactive(lubridate::mdy(paste0(rv$end_quarter(), "/", ifelse(input$quarter == "Q1" | input$quarter == "Q2", as.numeric(input$fy)-1,input$fy))))
       
        
        #2.2 observe event --------
        observeEvent(input$table_button, {
          
          #enable downloading after table in generated
          #enable("postcon_qa")
          enable("public_postcon")
          enable("public_con")
          enable("private_postcon")
          
          
          
          #name table in text output
          rv$header <- paste0("FY", input$fy, " ", input$quarter, " Quarterly Report Counts (", sf(rv$start_date()), " to ", sf(rv$end_date()), ")")
          output$header <- renderText(rv$header)
          
          #public (pu) post-construction (pc) (pupc) table
          rv$pupc_table <- bind_rows(
            pupc$sensors_deployed(), 
            pupc$systems_monitored(),
            pupc$systems_newly_monitored_qtr(),
            pupc$systems_monitored_to_date(),
            pupc$new_systems_QA_data_qtr(),
            pupc$systems_QA_data_to_date(),
            pupc$pre_inspection_qtr(), 
            pupc$pre_inspection_to_date(),
            pupc$cctv_dye_test_qtr(), 
            pupc$cctv_dye_test_to_date(),
            pupc$performance_srts_qtr(), 
            pupc$performance_srts_to_date(), 
            pupc$systems_tested_cet(),
            pupc$systems_tested_cet_to_date(),
            pupc$infiltration_system_tests_qtr(),
            pupc$infiltration_system_tests_to_date()
          )
          
          output$pupc_table <- renderDT(
            rv$pupc_table, 
            options = list(dom = 't', pageLength = 20)
          )
          
          #public construction table
          rv$puc_table <- bind_rows(
            puc$pre_inspection_qtr(), 
            puc$pre_inspection_to_date(),
            puc$cctv_dye_test_qtr(), 
            puc$cctv_dye_test_to_date(),
            puc$performance_srts_qtr(), 
            puc$performance_srts_to_date()
          )
          
          output$puc_table <- renderDT(
            rv$puc_table, 
            options = list(dom = 't')
          )
          
          rv$prpc_table <- bind_rows(
            prpc$sensors_deployed(), 
            prpc$systems_monitored(),
            prpc$systems_newly_monitored_qtr(),
            prpc$systems_monitored_to_date(),
            prpc$pre_inspection_qtr(), 
            prpc$pre_inspection_to_date(),
            prpc$cctv_dye_test_qtr(), 
            prpc$cctv_dye_test_to_date(),
            prpc$performance_srts_qtr(), 
            prpc$performance_srts_to_date(), 
            prpc$systems_tested_cet(),
            prpc$systems_tested_cet_to_date()
          )
          
          output$prpc_table <- renderDT(
            rv$prpc_table, 
            options = list(dom = 't')
          )

          #Downloading the QA query list of systems-3 sheets of systems/smps
          # output$postcon_qa <- downloadHandler(
          #   filename = function() {
          #     paste("FY",input$fy,"_",input$quarter,"_QA","_",Sys.Date(),".xlsx", sep = "")
          #   },
          #   content = function(filename){
          #     
          #     #Adding explaination of each sheet 
          #     sheet_1 <- rv$public_sys_smp_sensors_value()
          #     sheet_1["PUBLIC SMPs and Systems with sensors collected during the Quarter"] <- NA
          #     sheet_2 <- rv$cwl_sys_postcon_srt_value()
          #     sheet_2["Systems with CWL in Database or Post-construction SRTs compared to PostCon.xlsx"] <- NA
          #     sheet_3 <- rv$systems_no_cwl_before_value()
          #     sheet_3["System IDs that have never received CWL monitoring before this quarter's report"] <- NA
          #     
          #     df_list_qa <- list(sheet_1= sheet_1,
          #                        sheet_2= sheet_2,
          #                        sheet_3= sheet_3
          #                        )
          #     write.xlsx(x = df_list_qa , file = filename, rowNames = TRUE)
          #   }
          # )
       

          #Downloading the tables behind the counts
          output$public_postcon <- downloadHandler(
            filename = function() {
              paste("FY",input$fy,"_",input$quarter,"_PublicPostCon","_",Sys.Date(),".xlsx", sep = "")
            },
            content = function(filename){

              df_list_all <- list(Pub_PostCon_Metric_1=pupc$sensors_deployed_value_table(),
                                  Pub_PostCon_Metric_2=pupc$systems_monitored_value_table(),
                                  Pub_PostCon_Metric_3=pupc$systems_newly_monitored_qtr_value_table(),
                                  Pub_PostCon_Metric_4=pupc$systems_monitored_to_date_value_table(),
                                  Pub_PostCon_Metric_5=pupc$new_systems_QA_data_qtr_table(),
                                  Pub_PostCon_Metric_6=pupc$systems_QA_data_to_date_table(),
                                  Pub_PostCon_Metric_7=pupc$pre_inspection_qtr_value_table(),
                                  Pub_PostCon_Metric_8=pupc$pre_inspection_to_date_value_table(),
                                  Pub_PostCon_Metric_9=pupc$cctv_dye_test_qtr_value_table(),
                                  Pub_PostCon_Metric_10=pupc$cctv_dye_test_to_date_value_table(),
                                  Pub_PostCon_Metric_11=pupc$performance_srts_qtr_value_table(),
                                  Pub_PostCon_Metric_12=pupc$performance_srts_to_date_value_table(),
                                  Pub_PostCon_Metric_13=pupc$systems_tested_cet_value_table(),
                                  Pub_PostCon_Metric_14=pupc$systems_tested_cet_to_date_value_table(),
                                  Pub_PostCon_Metric_15=pupc$infiltration_system_tests_qtr_value_table(),
                                  Pub_PostCon_Metric_16=pupc$infiltration_system_tests_to_date_value_table())
              write.xlsx(x = df_list_all , file = filename, rowNames = TRUE)
            }
            
          )
          
          output$public_con <- downloadHandler(
            filename = function() {
              paste("FY",input$fy,"_",input$quarter,"_Public_Con","_",Sys.Date(),".xlsx", sep = "")
            },
            content = function(filename){
              
              df_list_all_con <- list(Pub_PostCon_Metric_1=puc$pre_inspection_qtr_value_table(),
                                  Pub_Con_Metric_2=puc$pre_inspection_to_date_value_table(),
                                  Pub_Con_Metric_3=puc$cctv_dye_test_qtr_value_table(),
                                  Pub_Con_Metric_4=puc$cctv_dye_test_to_date_value_table(),
                                  Pub_Con_Metric_5=puc$performance_srts_qtr_value_table(),
                                  Pub_Con_Metric_6=puc$performance_srts_to_date_value_table())
              write.xlsx(x = df_list_all_con , file = filename, rowNames = TRUE)
            }
          )
          
          output$private_postcon <- downloadHandler(
            filename = function() {
              paste("FY",input$fy,"_",input$quarter,"_Private_PostCon","_",Sys.Date(),".xlsx", sep = "")
            },
            content = function(filename){
              
              df_list_all_private <- list(Pri_PostCon_Metric_1=prpc$sensors_deployed_value_table(),
                                          Pri_PostCon_Metric_2=prpc$systems_monitored_value_table(),
                                          Pri_PostCon_Metric_3=prpc$systems_newly_monitored_qtr_value_table(),
                                          Pri_PostCon_Metric_4=prpc$systems_monitored_to_date_value_table(),
                                          Pri_PostCon_Metric_5=prpc$pre_inspection_qtr_value_table(),
                                          Pri_PostCon_Metric_6=prpc$pre_inspection_to_date_value_table(),
                                          Pri_PostCon_Metric_7=prpc$cctv_dye_test_qtr_value_table(),
                                          Pri_PostCon_Metric_8=prpc$cctv_dye_test_to_date_value_table(),
                                          Pri_PostCon_Metric_9=prpc$performance_srts_qtr_value_table(),
                                          Pri_PostCon_Metric_10=prpc$performance_srts_to_date_value_table(),
                                          Pri_PostCon_Metric_11=prpc$systems_tested_cet_value_table(),
                                          Pri_PostCon_Metric_12=prpc$systems_tested_cet_to_date_value_table())
              write.xlsx(x = df_list_all_private , file = filename, rowNames = TRUE)
            }
          )
          
          
          
        })

        
        #2.3 get values ---------
        
        #Get tables for metric 5 and QA queries
        entrydates <- dbGetQuery(poolConn, "SELECT *, data.fun_date_to_fiscal_quarter_null(found_in_ow_table) as found_quarter FROM data.tbl_ow_leveldata_entrydates WHERE smp_id LIKE '%-%-%'")
        fiscal_q <- dbGetQuery(poolConn, "SELECT * FROM admin.tbl_fiscal_quarter_lookup")
        
        #help with queries
        #this is like this because it makes it easier to copy from the other module 
        rv$quarter_range <- reactive(
          paste("AND test_date >= '", rv$start_date(), "' AND
                                             test_date <= '", rv$end_date(), "'")
        )
        
        rv$to_date_range <- reactive(
          paste("AND test_date <= '", rv$end_date(), "' ")
        )
        
        #from table located here: 
        #"O:\Watershed Sciences\GSI Monitoring\03 Reports and Presentations\08 Quarterly Reports\SOP\MARS_SOP\Template_[FYXXQX]_PostCon_MARS_Inputs.docx"
       
        
        #Post-con QA queries
        #Deployment Records - PUBLIC SMPs and Systems with sensors collected during the Quarter
        rv$public_sys_smp_sensors_query <- reactive(paste0("SELECT DISTINCT d.smp_id, admin.fun_smp_to_system(d.smp_id) AS system_id
                                                            FROM fieldwork.viw_deployment_full_cwl AS d
                                                            WHERE collection_dtime <='", rv$end_date(),"'AND collection_dtime >='", rv$start_date(),"' 
                                                            AND d.public = TRUE"))
        
        rv$public_sys_smp_sensors_value <- reactive(dbGetQuery(poolConn, rv$public_sys_smp_sensors_query()))
        
        
        #Post-con QA queries
        #Systems with CWL in Database or Post-construction SRTs compared to PostCon.xlsx
        rv$cwl_sys_postcon_srt_query <- reactive(paste0("WITH cte_smp_id_ow AS (
                                                              SELECT DISTINCT admin.fun_smp_to_system(smp_id) as system_id, ow_suffix, ow_uid
                                                              FROM fieldwork.tbl_ow
                                                              ),
                                                              cte_CWL_uid AS (
                                                              SELECT DISTINCT ow_uid
                                                              FROM data.tbl_ow_leveldata_raw
                                                              ),
                                                              srt_systems AS (
                                                              SELECT DISTINCT system_id
                                                              FROM fieldwork.tbl_srt
                                                              WHERE con_phase_lookup_uid = 2
                                                              AND test_date <'", rv$end_date(),"'
                                                              )
                                                              
                                                              SELECT DISTINCT system_id
                                                              FROM cte_CWL_uid AS l
                                                              INNER JOIN cte_smp_id_ow AS r
                                                              ON l.ow_uid = r.ow_uid
                                                              WHERE system_id like '%-%'
                                                              UNION SELECT * FROM srt_systems
                                                              WHERE system_id like '%-%'
                                                              ORDER BY system_id
                                                              "))
        
        rv$cwl_sys_postcon_srt_value <- reactive(dbGetQuery(poolConn,  rv$cwl_sys_postcon_srt_query()))
        
        #Post-con QA queries
        #System IDs that have never received CWL monitoring before this quarter's report
        #New systems with QA this Quarter
        
        #pull the current quarter
        current_fiscal_quid <- reactive ({
          
          current_q_uid <- fiscal_q %>%
            filter(fiscal_quarter == paste("FY",str_sub(input$fy,-2),input$quarter, sep = "")) %>%
            select(fiscal_quarter_lookup_uid) %>%
            pull
          
          return(current_q_uid)
        })
        
        #pull the next quarter
        next_fiscal_q <- reactive ({
          
          current_q_uid <- fiscal_q %>%
            filter(fiscal_quarter == paste("FY",str_sub(input$fy,-2),input$quarter, sep = "")) %>%
            select(fiscal_quarter_lookup_uid) %>%
            pull
          next_q <- fiscal_q %>%
            filter(fiscal_quarter_lookup_uid == current_q_uid+1) %>%
            select(fiscal_quarter) %>%
            pull
          
          return(next_q)
        })
        
        #QA query that returns the systems that have never had CWL before-the logic is updated and is different from the one in postcon table
        rv$systems_no_cwl_before_value <- reactive ({
          
          #systems when function data.fun_update_leveldata_insert_recordkeeping called for current quarter
          systems_current <- entrydates %>%
            filter(found_quarter ==next_fiscal_q() ) %>%
            select(system_id, earliest_data_date) %>%
            na.omit()%>%
            distinct()
          
          #systems when function data.fun_update_leveldata_insert_recordkeeping called for previous quarter
          system_previous <- entrydates %>%
            filter(found_quarter == paste("FY",str_sub(input$fy,-2),input$quarter, sep = ""))%>%
            select(system_id,earliest_data_date) %>%
            na.omit()%>%
            distinct()
          
          #New Systems With QA data this quarter
          newly_found_qa <- systems_current %>%
                                        anti_join(system_previous, by="system_id") %>%
                                        select(system_id)
          
          return(newly_found_qa)
          
        })
        
    
        #2.3.1 Section 2: Public Post-Construction (pupc) ----
        
        #reactive values for this section
        
        pupc <- reactiveValues()
        
        #help with queries
        pupc$public_query_text <- "AND public = TRUE"
        
        pupc$phase <- "Post-Construction"
        
        # Monitoring locations- unique combo of smp-id/ow_suffix
        
        pupc$sensors_deployed_q <- reactive(paste0("SELECT COUNT(distinct(smp_id, ow_suffix)) FROM fieldwork.viw_deployment_full_cwl 
                                             WHERE deployment_dtime <= '", rv$end_date(), "'
                                                    AND (collection_dtime >= '", rv$start_date(), "' 
                                             OR collection_dtime IS NULL) AND 
                                             public = TRUE AND smp_id is NOT NULL"))
        
        pupc$sensors_deployed_value <- reactive(dbGetQuery(poolConn, pupc$sensors_deployed_q()))
        pupc$sensors_deployed <- reactive(data.frame(Metric = "Monitoring Locations", 
                                                 Description = "Total unique combinations of smp id/observation well suffix",
                                                 Count = pupc$sensors_deployed_value()))
        
        #table for download
        pupc$sensors_deployed_q_table <- reactive(paste0("SELECT distinct(smp_id, ow_suffix) as location FROM fieldwork.viw_deployment_full_cwl 
                                             WHERE deployment_dtime <= '", rv$end_date(), "'
                                                    AND (collection_dtime >= '", rv$start_date(), "' 
                                             OR collection_dtime IS NULL) AND 
                                             public = TRUE AND smp_id is NOT NULL"))
        
        # table for download previous quarter
        pupc$sensors_deployed_previous_q_table <- reactive(paste0("SELECT distinct(smp_id, ow_suffix) as location FROM fieldwork.viw_deployment_full_cwl 
                                             WHERE deployment_dtime <= '", rv$end_date()%m-% months(3), "'
                                                    AND (collection_dtime >= '", rv$start_date()%m-% months(3), "' 
                                             OR collection_dtime IS NULL) AND 
                                             public = TRUE AND smp_id is NOT NULL"))
        pupc$sensors_deployed_value_previous_table <- reactive(dbGetQuery(poolConn, pupc$sensors_deployed_previous_q_table()) %>%
                                                                 mutate(present_in_prior_q = "Yes"))
        
        # full join between any two quarters in a row to show the differences across them
        pupc$sensors_deployed_value_table <- reactive(dbGetQuery(poolConn, pupc$sensors_deployed_q_table()) %>%
                                                        mutate(present_in_current_q = "Yes") %>%
                                                        full_join(pupc$sensors_deployed_value_previous_table(), by = "location") %>%
                                                        mutate(
                                                          present_in_current_q = coalesce(present_in_current_q, "No"),
                                                          present_in_prior_q = coalesce(present_in_prior_q, "No")
                                                        )
                                                        )
        
        #systems with CWL monitoring this quarter
        pupc$systems_monitored_q <- reactive(paste0("SELECT COUNT(DISTINCT admin.fun_smp_to_system(d.smp_id)) FROM fieldwork.viw_deployment_full_cwl d
                                                       WHERE deployment_dtime <= '", rv$end_date(), "'
                                                    AND (collection_dtime >= '", rv$start_date(), "'
                                             OR collection_dtime IS NULL)
                                                       AND d.public = TRUE AND smp_id is NOT NULL"))

        pupc$systems_monitored_value <- reactive(dbGetQuery(poolConn, pupc$systems_monitored_q()))
        pupc$systems_monitored <- reactive(data.frame(Metric = as.character("Systems Monitored this Quarter"), 
                                                      Description = "Systems at which HOBOs were deployed this quarter",
                                                      Count = pupc$systems_monitored_value()))
        
        #systems with CWL monitoring this quarter-entire table
        pupc$systems_monitored_q_table <- reactive(paste0("SELECT DISTINCT admin.fun_smp_to_system(d.smp_id) as system_id FROM fieldwork.viw_deployment_full_cwl d
                                                       WHERE deployment_dtime <= '", rv$end_date(), "'
                                                    AND (collection_dtime >= '", rv$start_date(), "'
                                             OR collection_dtime IS NULL)
                                                       AND d.public = TRUE AND smp_id is NOT NULL"))
        
        #systems with CWL monitoring this quarter-entire table
        pupc$systems_monitored_q_previous_table <- reactive(paste0("SELECT DISTINCT admin.fun_smp_to_system(d.smp_id) as system_id FROM fieldwork.viw_deployment_full_cwl d
                                                       WHERE deployment_dtime <= '", rv$end_date()%m-% months(3), "'
                                                    AND (collection_dtime >= '", rv$start_date()%m-% months(3), "'
                                             OR collection_dtime IS NULL)
                                                       AND d.public = TRUE AND smp_id is NOT NULL"))
        pupc$systems_monitored_value_previous_table <- reactive(dbGetQuery(poolConn, pupc$systems_monitored_q_previous_table()) %>%
                                                                  mutate(present_in_prior_q = "Yes")
                                                                  )
        
        pupc$systems_monitored_value_table <- reactive(dbGetQuery(poolConn, pupc$systems_monitored_q_table()) %>%
                                                         mutate(present_in_current_q = "Yes") %>%
                                                         full_join(pupc$systems_monitored_value_previous_table(), by = "system_id") %>%
                                                         mutate(
                                                           present_in_current_q = coalesce(present_in_current_q, "No"),
                                                           present_in_prior_q = coalesce(present_in_prior_q, "No")
                                                         )
                                                         )

        #Systems newly monitored this quarter
        #Systems deployed at for the first time this quarter
        pupc$systems_newly_monitored_qtr_q <- reactive(paste0("with last_quarter as (SELECT DISTINCT admin.fun_smp_to_system(d.smp_id) as system_id FROM fieldwork.viw_deployment_full_cwl d
          WHERE d.public = TRUE and deployment_dtime < '", rv$start_date(), "' and admin.fun_smp_to_system(d.smp_id) is not null)
                
          SELECT count(DISTINCT(admin.fun_smp_to_system(d.smp_id))) FROM fieldwork.viw_deployment_full_cwl d
            WHERE d.public = TRUE and deployment_dtime <= '", rv$end_date(), "' 
            and admin.fun_smp_to_system(d.smp_id) is not null and admin.fun_smp_to_system(d.smp_id) not in (select * from last_quarter)"))
        pupc$systems_newly_monitored_qtr_value <- reactive(dbGetQuery(poolConn, pupc$systems_newly_monitored_qtr_q()))
        pupc$systems_newly_monitored_qtr <- reactive(data.frame(Metric = as.character("Systems Newly Monitored this Quarter"), 
                                                                Description = "Systems at which HOBOs were deployed for the first time this quarter",
                                                                Count = pupc$systems_newly_monitored_qtr_value()))
        #Systems newly monitored this quarter-table download
        #Systems deployed at for the first time this quarter
        pupc$systems_newly_monitored_qtr_q_table <- reactive(paste0("with last_quarter as (SELECT DISTINCT admin.fun_smp_to_system(d.smp_id) as system_id FROM fieldwork.viw_deployment_full_cwl d
          WHERE d.public = TRUE and deployment_dtime < '", rv$start_date(), "' and admin.fun_smp_to_system(d.smp_id) is not null)
                
          SELECT DISTINCT(admin.fun_smp_to_system(d.smp_id)) FROM fieldwork.viw_deployment_full_cwl d
            WHERE d.public = TRUE and deployment_dtime <= '", rv$end_date(), "' 
            and admin.fun_smp_to_system(d.smp_id) is not null and admin.fun_smp_to_system(d.smp_id) not in (select * from last_quarter)"))
        pupc$systems_newly_monitored_qtr_value_table <- reactive(dbGetQuery(poolConn, pupc$systems_newly_monitored_qtr_q_table()))
        
        #systems with CWL monitoring to-date
        #No. of public systems monitored to date
        pupc$systems_monitored_to_date_q <- reactive(paste0("SELECT COUNT(DISTINCT admin.fun_smp_to_system(d.smp_id)) FROM fieldwork.viw_deployment_full_cwl d
                                                    WHERE d.public = TRUE and smp_id is NOT NULL and deployment_dtime <= '", rv$end_date(), "'"))

        pupc$systems_monitored_to_date_value <- reactive(dbGetQuery(poolConn, pupc$systems_monitored_to_date_q()))
        pupc$systems_monitored_to_date <- reactive(data.frame(Metric = as.character("Systems Monitored to-Date"),
                                                                   Description = "All systems at which HOBOs have been deployed",
                                                                   Count = pupc$systems_monitored_to_date_value()))
        #table version for dl
        pupc$systems_monitored_to_date_q_table <- reactive(paste0("SELECT DISTINCT admin.fun_smp_to_system(d.smp_id) FROM fieldwork.viw_deployment_full_cwl d
                                                    WHERE d.public = TRUE and smp_id is NOT NULL and deployment_dtime <= '", rv$end_date(), "'"))
        
        pupc$systems_monitored_to_date_value_table <- reactive(dbGetQuery(poolConn, pupc$systems_monitored_to_date_q_table()))
# 
#         #systems with QA'd CWL Data to-date
#         pupc$new_systems_QA_data_qtr_q <- reactive(paste0("with fq_input as (select fiscal_quarter_lookup_uid from admin.tbl_fiscal_quarter_lookup WHERE fiscal_quarter = 'FY",
#                                                               str_sub(input$fy,-2),input$quarter,"') ,
#                                                               
#                                                               newest_smps as (select distinct system_id from data.tbl_ow_leveldata_entrydates 
#                                                               where fiscal_quarter_lookup_uid = (select max(fiscal_quarter_lookup_uid) from fq_input)),
#                                                               
#                                                               previous_date as (select max(fiscal_quarter_lookup_uid) as previous_date from data.tbl_ow_leveldata_entrydates 
#                                                               where fiscal_quarter_lookup_uid < (select max(fiscal_quarter_lookup_uid)from fq_input)),
#                                                               
#                                                               previous_smps as (select distinct system_id from data.tbl_ow_leveldata_entrydates 
#                                                               where fiscal_quarter_lookup_uid <= (select previous_date from previous_date))
#                                                               
#                                                               select COUNT(*) from newest_smps 
#                                                               where system_id not in (select system_id from previous_smps) -- System never given CWL before
#                                                               and system_id like '%-%' -- Public SMPs only"))
#         
#         pupc$new_systems_QA_data_qtr_value <- reactive(dbGetQuery(poolConn, pupc$new_systems_QA_data_qtr_q()))
#         pupc$new_systems_QA_data_qtr <- reactive(data.frame(Metric = "New Systems With QA data this quarter",
#                                                             Description = "Systems that have QA data for the first time this quarter",
#                                                               Count = pupc$new_systems_QA_data_qtr_value()))
# 
#         pupc$systems_QA_data_to_date_q <- reactive(paste0("with fq_input as (select fiscal_quarter_lookup_uid from admin.tbl_fiscal_quarter_lookup WHERE fiscal_quarter = 'FY",
#                                                           str_sub(input$fy,-2),input$quarter,"') ,
#                                                               
#                                                               current_systems as (select distinct system_id from data.tbl_ow_leveldata_entrydates 
#                                                               where fiscal_quarter_lookup_uid <= (select max(fiscal_quarter_lookup_uid) from fq_input))
#                                                               
#                                                               select COUNT(*) from current_systems 
#                                                               where system_id like '%-%' -- Public Systems only"))
#         
#         pupc$systems_QA_data_to_date_value <- reactive(dbGetQuery(poolConn, pupc$systems_QA_data_to_date_q()))
#         pupc$systems_QA_data_to_date <- reactive(data.frame(Metric = "Systems With QA data to-Date",
#                                                             Description = "All systems with QA data in the Postgres database",
#                                                             Count = pupc$systems_QA_data_to_date_value()))
        
        
    #change the logic of metics 5 and 6 and based it off the found_in_ow_table
        
        #New systems with QA this Quarter
        newly_found_systems <- reactive ({
          
        #systems when function data.fun_update_leveldata_insert_recordkeeping called for current quarter
        systems_current <- entrydates %>%
          filter(found_quarter ==next_fiscal_q() ) %>%
          select(system_id, earliest_data_date) %>%
          na.omit()%>%
          distinct()

        #systems when function data.fun_update_leveldata_insert_recordkeeping called for previous quarter
        system_previous <- entrydates %>%
          filter(found_quarter == paste("FY",str_sub(input$fy,-2),input$quarter, sep = ""))%>%
          select(system_id,earliest_data_date) %>%
          na.omit()%>%
          distinct()

        #New Systems With QA data this quarter
        newly_found <- data.frame(count=systems_current %>%
          anti_join(system_previous, by="system_id") %>%
          select(system_id) %>%
          distinct() %>%
          nrow())
        
        return(newly_found)

        })
        
        
        #Systems With QA data to-Date
        todate_qa_systems <- reactive({
          
        systems_current <- entrydates %>%
            filter(found_quarter ==next_fiscal_q() ) %>%
            select(system_id, earliest_data_date) %>%
            na.omit()%>%
            distinct()
          
        #Systems With QA data to-Date
        todate<- data.frame(count = systems_current %>%
                 select(system_id) %>%
                 distinct() %>%
                 nrow())
        
        return(todate)
          
        })
        
        #The logic only works for FY22Q3 and beyond otherwise returns NA
        pupc$new_systems_QA_data_qtr <- reactive({
          
          if(current_fiscal_quid()>45){
           output_qa_systems <- data.frame(Metric = "New Systems With QA data this quarter",
                                                            Description = "Systems whose QA data entered the database for the first time this quarter",
                                                            Count = newly_found_systems())
          } else{
           output_qa_systems <- data.frame(Metric = "New Systems With QA data this quarter",
                                         Description = "Systems whose QA data entered the database for the first time this quarter",
                                         count = NA)
          }
          return(output_qa_systems)
          
          })
        
        pupc$systems_QA_data_to_date <- reactive({
          
          if(current_fiscal_quid()>45){
            output_qa_systems_todate <- data.frame(Metric = "Systems With QA data to-Date",
                                                            Description = "All systems with QA data in the Postgres database",
                                                            Count = todate_qa_systems())
          } else{
            output_qa_systems_todate <- data.frame(Metric = "Systems With QA data to-Date",
                                                            Description = "All systems with QA data in the Postgres database",
                                                            count = NA)
          }
          return(output_qa_systems_todate)
          
        })
        
        #Tables for download
        pupc$new_systems_QA_data_qtr_table <- reactive({
          
          if(current_fiscal_quid()>45){
            output_qa_systems_table <- rv$systems_no_cwl_before_value() %>%
              select(system_id) %>%
              distinct()
          } else{
            output_qa_systems_table <- NA
          }
          return(output_qa_systems_table)
          
        })
        
        pupc$systems_QA_data_to_date_table <- reactive({
          
          if(current_fiscal_quid()>45){
            output_qa_systems_todate_table <- entrydates %>%
              filter(found_quarter ==next_fiscal_q() ) %>%
              select(system_id, earliest_data_date) %>%
              na.omit()%>%
              distinct()%>%
              select(system_id) %>%
              distinct
            
          } else{
            output_qa_systems_todate_table <- NA 
          }
          return(output_qa_systems_todate_table)
          
        })
        
        
        
        #SRT pre-inspection tests this quarter
        pupc$pre_inspection_qtr_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", pupc$phase, "' AND
                                             type = 'Pre-Inspection Dye Test'", rv$quarter_range(), pupc$public_query_text))

        pupc$pre_inspection_qtr_value <- reactive(dbGetQuery(poolConn, pupc$pre_inspection_qtr_q()))

        pupc$pre_inspection_qtr <- reactive(data.frame(Metric = "Pre-Inspection Dye Tests this Quarter",
                                                 Count = pupc$pre_inspection_qtr_value()))
        
        #SRT pre-inspection tests this quarter-table
        pupc$pre_inspection_qtr_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", pupc$phase, "' AND
                                             type = 'Pre-Inspection Dye Test'", rv$quarter_range(), pupc$public_query_text))
        
        pupc$pre_inspection_qtr_value_table <- reactive(dbGetQuery(poolConn, pupc$pre_inspection_qtr_q_table()))
        
        
        #SRT pre-inspection tests to-date
        pupc$pre_inspection_to_date_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", pupc$phase, "' AND
                                             type = 'Pre-Inspection Dye Test'", rv$to_date_range(), pupc$public_query_text))
        
        pupc$pre_inspection_to_date_value <- reactive(dbGetQuery(poolConn, pupc$pre_inspection_to_date_q()))
        
        #SRT pre-inspection tests to-date-table
        pupc$pre_inspection_to_date_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", pupc$phase, "' AND
                                             type = 'Pre-Inspection Dye Test'", rv$to_date_range(), pupc$public_query_text))
        
        pupc$pre_inspection_to_date_value_table <- reactive(dbGetQuery(poolConn, pupc$pre_inspection_to_date_q_table()))
        
        pupc$pre_inspection_to_date <- reactive(data.frame(Metric = "Pre-Inspection Dye Tests to-Date",
                                                       Count = pupc$pre_inspection_to_date_value()))
        #SRT pre-inspection tests to-date-table dl
        pupc$pre_inspection_to_date_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", pupc$phase, "' AND
                                             type = 'Pre-Inspection Dye Test'", rv$to_date_range(), pupc$public_query_text))
        
        pupc$pre_inspection_to_date_value_table <- reactive(dbGetQuery(poolConn, pupc$pre_inspection_to_date_q_table()))
        
        #SRT CCTV/ Dye Tests this quarter
        pupc$cctv_dye_test_qtr_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", pupc$phase, "' AND
                                             type = 'CCTV Dye Test'", rv$quarter_range(), pupc$public_query_text))
        
        pupc$cctv_dye_test_qtr_value <- reactive(dbGetQuery(poolConn, pupc$cctv_dye_test_qtr_q()))
        
        pupc$cctv_dye_test_qtr <- reactive(data.frame(Metric = "CCTV Dye Tests this Quarter",
                                                       Count = pupc$cctv_dye_test_qtr_value()))
        #SRT CCTV/ Dye Tests this quarter-table download
        pupc$cctv_dye_test_qtr_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", pupc$phase, "' AND
                                             type = 'CCTV Dye Test'", rv$quarter_range(), pupc$public_query_text))
        
        pupc$cctv_dye_test_qtr_value_table <- reactive(dbGetQuery(poolConn, pupc$cctv_dye_test_qtr_q_table()))
        
        #SRT CCTV/ Dye Tests this to-date
        pupc$cctv_dye_test_to_date_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", pupc$phase, "' AND
                                             type = 'CCTV Dye Test'", rv$to_date_range(), pupc$public_query_text))
        
        pupc$cctv_dye_test_to_date_value <- reactive(dbGetQuery(poolConn, pupc$cctv_dye_test_to_date_q()))
        
        #SRT CCTV/ Dye Tests this to-date-table
        pupc$cctv_dye_test_to_date_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", pupc$phase, "' AND
                                             type = 'CCTV Dye Test'", rv$to_date_range(), pupc$public_query_text))
        
        pupc$cctv_dye_test_to_date_value_table <- reactive(dbGetQuery(poolConn, pupc$cctv_dye_test_to_date_q_table()))
        
        pupc$cctv_dye_test_to_date <- reactive(data.frame(Metric = "CCTV Dye Tests to-Date",
                                                           Count = pupc$cctv_dye_test_to_date_value()))
        
        #SRT Performance Tests this quarter
        pupc$performance_srts_qtr_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", pupc$phase, "' AND
                                             type = 'Performance Test'", rv$quarter_range(), pupc$public_query_text))
        
        pupc$performance_srts_qtr_value <- reactive(dbGetQuery(poolConn, pupc$performance_srts_qtr_q()))
        
        pupc$performance_srts_qtr <- reactive(data.frame(Metric = "Performance Tests this Quarter",
                                                       Count = pupc$performance_srts_qtr_value()))
        
        #SRT Performance Tests this quarter-table
        pupc$performance_srts_qtr_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", pupc$phase, "' AND
                                             type = 'Performance Test'", rv$quarter_range(), pupc$public_query_text))
        
        pupc$performance_srts_qtr_value_table <- reactive(dbGetQuery(poolConn, pupc$performance_srts_qtr_q_table()))
        
        #SRT Performance Tests to-date
        pupc$performance_srts_to_date_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", pupc$phase, "' AND
                                             type = 'Performance Test'", rv$to_date_range(), pupc$public_query_text))
        
        pupc$performance_srts_to_date_value <- reactive(dbGetQuery(poolConn, pupc$performance_srts_to_date_q()))
        
        pupc$performance_srts_to_date <- reactive(data.frame(Metric = "Performance Tests to-Date",
                                                           Count = pupc$performance_srts_to_date_value()))
        
        #SRT Performance Tests to-date-table
        pupc$performance_srts_to_date_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", pupc$phase, "' AND
                                             type = 'Performance Test'", rv$to_date_range(), pupc$public_query_text))
        
        pupc$performance_srts_to_date_value_table <- reactive(dbGetQuery(poolConn, pupc$performance_srts_to_date_q_table()))
        
        #systems with capture efficiency testing administered this quarter
        pupc$systems_tested_cet_q <- reactive(paste0("with old_systems as (select system_id, min(test_date) as earliest_test 
            from fieldwork.viw_capture_efficiency_full where phase = '", 
                                                     pupc$phase, "' AND test_date < '", 
                                                     rv$start_date(), "' ", pupc$public_query_text, 
                                                     " AND low_flow_bypass_observed IS NOT NULL group by system_id)
  
            SELECT count(distinct(system_id)) FROM fieldwork.viw_capture_efficiency_full 
            WHERE phase = '", pupc$phase, "'", rv$quarter_range(), 
                                                     pupc$public_query_text, " AND low_flow_bypass_observed IS NOT NULL 
            and system_id not in (select system_id from old_systems)"))        
        pupc$systems_tested_cet_value <- reactive(dbGetQuery(poolConn, pupc$systems_tested_cet_q()))
        
        pupc$systems_tested_cet <- reactive(data.frame(Metric = "New Systems with Capture Efficiency Tests this Quarter", 
                                                     Count = pupc$systems_tested_cet_value()))
        
        #systems with capture efficiency testing administered this quarter-table
        pupc$systems_tested_cet_q_table <- reactive(paste0("with old_systems as (select system_id, min(test_date) as earliest_test 
            from fieldwork.viw_capture_efficiency_full where phase = '", 
                                                     pupc$phase, "' AND test_date < '", 
                                                     rv$start_date(), "' ", pupc$public_query_text, 
                                                     " AND low_flow_bypass_observed IS NOT NULL group by system_id)
  
            SELECT distinct(system_id) FROM fieldwork.viw_capture_efficiency_full 
            WHERE phase = '", pupc$phase, "'", rv$quarter_range(), 
                                                     pupc$public_query_text, " AND low_flow_bypass_observed IS NOT NULL 
            and system_id not in (select system_id from old_systems)"))        
        pupc$systems_tested_cet_value_table <- reactive(dbGetQuery(poolConn, pupc$systems_tested_cet_q_table()))
        
        
        
        #systems with capture efficiency testing administered to date
        pupc$systems_tested_cet_to_date_q <- reactive(paste0("SELECT COUNT(distinct system_id) FROM fieldwork.viw_capture_efficiency_full 
            WHERE phase = '", pupc$phase, "'", rv$to_date_range(), pupc$public_query_text, " AND low_flow_bypass_observed IS NOT NULL"))
        
        pupc$systems_tested_cet_to_date_value <- reactive(dbGetQuery(poolConn, pupc$systems_tested_cet_to_date_q()))
        
        pupc$systems_tested_cet_to_date <- reactive(data.frame(Metric = "Systems with Capture Efficiency Tests to-Date", 
                                                       Count = pupc$systems_tested_cet_to_date_value()))
        
        #systems with capture efficiency testing administered to date-table dl
        pupc$systems_tested_cet_to_date_q_table <- reactive(paste0("SELECT distinct system_id FROM fieldwork.viw_capture_efficiency_full 
            WHERE phase = '", pupc$phase, "'", rv$to_date_range(), pupc$public_query_text, " AND low_flow_bypass_observed IS NOT NULL"))
        
        pupc$systems_tested_cet_to_date_value_table <- reactive(dbGetQuery(poolConn, pupc$systems_tested_cet_to_date_q_table()))
        
        #infiltration system-tests this quarter (subtracting ten because of some tests that took part on multiple)
        pupc$infiltration_system_tests_qtr_q <- reactive(paste0("SELECT count(*) FROM fieldwork.viw_porous_pavement_smp_averages
                                                          WHERE test_date >= '", rv$start_date(), "' AND
                                                               test_date <= '", rv$end_date(), "'"))

        pupc$infiltration_system_tests_qtr_value <- reactive(dbGetQuery(poolConn, pupc$infiltration_system_tests_qtr_q()))

        pupc$infiltration_system_tests_qtr <- reactive(data.frame(Metric = "Porous Pavement Infiltration System-Tests this Quarter",
                                                       Count = pupc$infiltration_system_tests_qtr_value()))
        
        #infiltration system-tests this quarter (subtracting ten because of some tests that took part on multiple)-table dl
        pupc$infiltration_system_tests_qtr_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_porous_pavement_smp_averages
                                                          WHERE test_date >= '", rv$start_date(), "' AND
                                                               test_date <= '", rv$end_date(), "'"))
        
        pupc$infiltration_system_tests_qtr_value_table <- reactive(dbGetQuery(poolConn, pupc$infiltration_system_tests_qtr_q_table()))
        
        
        #infiltration system-tests to-date
        pupc$infiltration_system_tests_to_date_q <- reactive(paste0("SELECT (count(*) - 10) as count FROM fieldwork.viw_porous_pavement_smp_averages
                                                          WHERE test_date <= '", rv$end_date(), "'"))
        
        pupc$infiltration_system_tests_to_date_value <- reactive(dbGetQuery(poolConn, pupc$infiltration_system_tests_to_date_q()))
        
        pupc$infiltration_system_tests_to_date <- reactive(data.frame(Metric = "Porous Pavement Infiltration System-Tests to-Date",
                                                       Count = pupc$infiltration_system_tests_to_date_value()))
        
        #infiltration system-tests to-date-dl
        pupc$infiltration_system_tests_to_date_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_porous_pavement_smp_averages
                                                          WHERE test_date <= '", rv$end_date(), "'","order by test_date OFFSET 10"))
        
        pupc$infiltration_system_tests_to_date_value_table <- reactive(dbGetQuery(poolConn, pupc$infiltration_system_tests_to_date_q_table()))
        
        #2.3.2 Section 5: Public Construction  ----
        
        puc <- reactiveValues()
        
        #help with queries
        puc$public_query_text <- "AND public = TRUE"
        
        puc$phase <- "Construction"
        
        #SRT pre-inspection tests this quarter
        puc$pre_inspection_qtr_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", puc$phase, "' AND
                                             type = 'Pre-Inspection Dye Test'", rv$quarter_range(), puc$public_query_text))
        
        puc$pre_inspection_qtr_value <- reactive(dbGetQuery(poolConn, puc$pre_inspection_qtr_q()))
        
        puc$pre_inspection_qtr <- reactive(data.frame(Metric = "Pre-Inspection Dye Tests this Quarter",
                                                      Count = puc$pre_inspection_qtr_value()))
        #SRT pre-inspection tests this quarter-table download
        puc$pre_inspection_qtr_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", puc$phase, "' AND
                                             type = 'Pre-Inspection Dye Test'", rv$quarter_range(), puc$public_query_text))
        
        puc$pre_inspection_qtr_value_table <- reactive(dbGetQuery(poolConn, puc$pre_inspection_qtr_q_table()))
        
        #SRT pre-inspection tests to-date
        puc$pre_inspection_to_date_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", puc$phase, "' AND
                                             type = 'Pre-Inspection Dye Test'", rv$to_date_range(), puc$public_query_text))
        
        puc$pre_inspection_to_date_value <- reactive(dbGetQuery(poolConn, puc$pre_inspection_to_date_q()))
        
        puc$pre_inspection_to_date <- reactive(data.frame(Metric = "Pre-Inspection Dye Tests to-Date",
                                                          Count = puc$pre_inspection_to_date_value()))
        
        #SRT pre-inspection tests to-date-table
        puc$pre_inspection_to_date_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", puc$phase, "' AND
                                             type = 'Pre-Inspection Dye Test'", rv$to_date_range(), puc$public_query_text))
        
        puc$pre_inspection_to_date_value_table <- reactive(dbGetQuery(poolConn, puc$pre_inspection_to_date_q_table()))
        
        
        #SRT CCTV/ Dye Tests this quarter
        puc$cctv_dye_test_qtr_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", puc$phase, "' AND
                                             type = 'CCTV Dye Test'", rv$quarter_range(), puc$public_query_text))
        
        puc$cctv_dye_test_qtr_value <- reactive(dbGetQuery(poolConn, puc$cctv_dye_test_qtr_q()))
        
        puc$cctv_dye_test_qtr <- reactive(data.frame(Metric = "CCTV Dye Tests this Quarter",
                                                     Count = puc$cctv_dye_test_qtr_value()))
        
        #SRT CCTV/ Dye Tests this quarter-table
        puc$cctv_dye_test_qtr_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", puc$phase, "' AND
                                             type = 'CCTV Dye Test'", rv$quarter_range(), puc$public_query_text))
        
        puc$cctv_dye_test_qtr_value_table <- reactive(dbGetQuery(poolConn, puc$cctv_dye_test_qtr_q_table()))
        
        #SRT CCTV/ Dye Tests this to-date
        puc$cctv_dye_test_to_date_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", puc$phase, "' AND
                                             type = 'CCTV Dye Test'", rv$to_date_range(), puc$public_query_text))
        
        puc$cctv_dye_test_to_date_value <- reactive(dbGetQuery(poolConn, puc$cctv_dye_test_to_date_q()))
        puc$cctv_dye_test_to_date <- reactive(data.frame(Metric = "CCTV Dye Tests to-Date",
                                                         Count = puc$cctv_dye_test_to_date_value()))
        
        #SRT CCTV/ Dye Tests this to-date-table
        puc$cctv_dye_test_to_date_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", puc$phase, "' AND
                                             type = 'CCTV Dye Test'", rv$to_date_range(), puc$public_query_text))
        
        puc$cctv_dye_test_to_date_value_table <- reactive(dbGetQuery(poolConn, puc$cctv_dye_test_to_date_q_table()))
        
       
        
        #SRT Performance Tests this quarter
        puc$performance_srts_qtr_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", puc$phase, "' AND
                                             type = 'Performance Test'", rv$quarter_range(), puc$public_query_text))
        
        puc$performance_srts_qtr_value <- reactive(dbGetQuery(poolConn, puc$performance_srts_qtr_q()))
        
        puc$performance_srts_qtr <- reactive(data.frame(Metric = "Performance Tests this Quarter",
                                                        Count = puc$performance_srts_qtr_value()))
        
        #SRT Performance Tests this quarter-table
        puc$performance_srts_qtr_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", puc$phase, "' AND
                                             type = 'Performance Test'", rv$quarter_range(), puc$public_query_text))
        
        puc$performance_srts_qtr_value_table <- reactive(dbGetQuery(poolConn, puc$performance_srts_qtr_q_table()))
        
        
        #SRT Performance Tests to-date
        puc$performance_srts_to_date_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", puc$phase, "' AND
                                             type = 'Performance Test'", rv$to_date_range(), puc$public_query_text))
        
        puc$performance_srts_to_date_value <- reactive(dbGetQuery(poolConn, puc$performance_srts_to_date_q()))
        
        puc$performance_srts_to_date <- reactive(data.frame(Metric = "Performance Tests to-Date",
                                                            Count = puc$performance_srts_to_date_value()))
        
        #SRT Performance Tests to-date-table
        puc$performance_srts_to_date_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", puc$phase, "' AND
                                             type = 'Performance Test'", rv$to_date_range(), puc$public_query_text))
        
        puc$performance_srts_to_date_value_table <- reactive(dbGetQuery(poolConn, puc$performance_srts_to_date_q_table()))
        
        
        
        #2.3.3 Section 6: Private Post-Construction -----
        
        #reactive values for this section
        
        prpc <- reactiveValues()
        
        #help with queries
        prpc$public_query_text <- "AND public = FALSE"
        
        prpc$phase <- "Post-Construction"
        
        # Monitoring locations- unique combo of smp-id/ow_suffix
        prpc$sensors_deployed_q <- reactive(paste0("SELECT COUNT(distinct(smp_id, ow_suffix)) FROM fieldwork.viw_deployment_full_cwl 
                                             WHERE deployment_dtime <= '", rv$end_date(), "'
                                                    AND (collection_dtime >= '", rv$start_date(), "' 
                                             OR collection_dtime IS NULL) AND 
                                             public = FALSE"))
        
        prpc$sensors_deployed_value <- reactive(dbGetQuery(poolConn, prpc$sensors_deployed_q()))
        prpc$sensors_deployed <- reactive(data.frame(Metric = "Monitoring Locations", 
                                                     Description = "Total unique combinations of smp id/observation well suffix",
                                                     Count = prpc$sensors_deployed_value()))
        
        #dl table
        prpc$sensors_deployed_q_table <- reactive(paste0("SELECT distinct(smp_id, ow_suffix) as location FROM fieldwork.viw_deployment_full_cwl 
                                             WHERE deployment_dtime <= '", rv$end_date(), "'
                                                    AND (collection_dtime >= '", rv$start_date(), "' 
                                             OR collection_dtime IS NULL) AND 
                                             public = FALSE"))
        # previous table
        prpc$sensors_deployed_q_previous_table <- reactive(paste0("SELECT distinct(smp_id, ow_suffix) as location FROM fieldwork.viw_deployment_full_cwl 
                                             WHERE deployment_dtime <= '", rv$end_date()%m-% months(3), "'
                                                    AND (collection_dtime >= '", rv$start_date()%m-% months(3), "' 
                                             OR collection_dtime IS NULL) AND 
                                             public = FALSE"))
        
        
        prpc$sensors_deployed_value_previous_table <- reactive(dbGetQuery(poolConn, prpc$sensors_deployed_q_previous_table()) %>%
                                                                 mutate(present_in_prior_q = "Yes")
                                                                 )
        
        prpc$sensors_deployed_value_table <- reactive(dbGetQuery(poolConn, prpc$sensors_deployed_q_table()) %>%
                                                        mutate(present_in_current_q = "Yes") %>%
                                                        full_join(prpc$sensors_deployed_value_previous_table(), by = "location") %>%
                                                        mutate(
                                                          present_in_current_q = coalesce(present_in_current_q, "No"),
                                                          present_in_prior_q = coalesce(present_in_prior_q, "No")
                                                        ))
        
        
        #systems with CWL monitoring this quarter
        prpc$systems_monitored_q <- reactive(paste0("SELECT COUNT(DISTINCT admin.fun_smp_to_system(d.smp_id)) FROM fieldwork.viw_deployment_full_cwl d
                                                       WHERE deployment_dtime <= '", rv$end_date(), "'
                                                    AND (collection_dtime >= '", rv$start_date(), "'
                                             OR collection_dtime IS NULL)
                                                       AND d.public = FALSE"))
        
        prpc$systems_monitored_value <- reactive(dbGetQuery(poolConn, prpc$systems_monitored_q()))
        prpc$systems_monitored <- reactive(data.frame(Metric = as.character("Systems Monitored this Quarter"), 
                                                      Description = "Systems at which HOBOs were deployed this quarter",
                                                      Count = prpc$systems_monitored_value()))
        
        #systems with CWL monitoring this quarter-table
        prpc$systems_monitored_q_table <- reactive(paste0("SELECT DISTINCT admin.fun_smp_to_system(d.smp_id) as system_id FROM fieldwork.viw_deployment_full_cwl d
                                                       WHERE deployment_dtime <= '", rv$end_date(), "'
                                                    AND (collection_dtime >= '", rv$start_date(), "'
                                             OR collection_dtime IS NULL)
                                                       AND d.public = FALSE"))
        
        # prior quarter
        prpc$systems_monitored_q_previous_table <- reactive(paste0("SELECT DISTINCT admin.fun_smp_to_system(d.smp_id) as system_id FROM fieldwork.viw_deployment_full_cwl d
                                                       WHERE deployment_dtime <= '", rv$end_date()%m-% months(3), "'
                                                    AND (collection_dtime >= '", rv$start_date()%m-% months(3), "'
                                             OR collection_dtime IS NULL)
                                                       AND d.public = FALSE"))
        
        
        prpc$systems_monitored_value_previous_table <- reactive(dbGetQuery(poolConn, prpc$systems_monitored_q_previous_table()) %>%
                                                                  mutate(present_in_prior_q = "Yes"))
        
        
        prpc$systems_monitored_value_table <- reactive(dbGetQuery(poolConn, prpc$systems_monitored_q_table()) %>%
                                                         mutate(present_in_current_q = "Yes") %>%
                                                         full_join(prpc$systems_monitored_value_previous_table(), by = "system_id") %>%
                                                         mutate(
                                                           present_in_current_q = coalesce(present_in_current_q, "No"),
                                                           present_in_prior_q = coalesce(present_in_prior_q, "No")
                                                         ))
        
        #Systems newly monitored this quarter
        #Systems deployed at for the first time this quarter
        prpc$systems_newly_monitored_qtr_q <- reactive(paste0("with last_quarter as (SELECT DISTINCT admin.fun_smp_to_system(d.smp_id) as system_id FROM fieldwork.viw_deployment_full_cwl d
          WHERE d.public = FALSE and deployment_dtime < '", rv$start_date(), "' and admin.fun_smp_to_system(d.smp_id) is not null)
                
          SELECT count(DISTINCT(admin.fun_smp_to_system(d.smp_id))) FROM fieldwork.viw_deployment_full_cwl d
            WHERE d.public = FALSE and deployment_dtime <= '", rv$end_date(), "' 
            and admin.fun_smp_to_system(d.smp_id) is not null and admin.fun_smp_to_system(d.smp_id) not in (select * from last_quarter)"))
        prpc$systems_newly_monitored_qtr_value <- reactive(dbGetQuery(poolConn, prpc$systems_newly_monitored_qtr_q()))
        prpc$systems_newly_monitored_qtr <- reactive(data.frame(Metric = as.character("Systems Newly Monitored this Quarter"), 
                                                                Description = "Systems at which HOBOs were deployed for the first time this quarter",
                                                                Count = prpc$systems_newly_monitored_qtr_value()))
        
        #Systems newly monitored this quarter-table
        #Systems deployed at for the first time this quarter
        prpc$systems_newly_monitored_qtr_q_table <- reactive(paste0("with last_quarter as (SELECT DISTINCT admin.fun_smp_to_system(d.smp_id) as system_id FROM fieldwork.viw_deployment_full_cwl d
          WHERE d.public = FALSE and deployment_dtime < '", rv$start_date(), "' and admin.fun_smp_to_system(d.smp_id) is not null)
                
          SELECT DISTINCT(admin.fun_smp_to_system(d.smp_id)) FROM fieldwork.viw_deployment_full_cwl d
            WHERE d.public = FALSE and deployment_dtime <= '", rv$end_date(), "' 
            and admin.fun_smp_to_system(d.smp_id) is not null and admin.fun_smp_to_system(d.smp_id) not in (select * from last_quarter)"))
        prpc$systems_newly_monitored_qtr_value_table <- reactive(dbGetQuery(poolConn, prpc$systems_newly_monitored_qtr_q_table()))
        
        #systems with CWL monitoring to-date
        #No. of public systems monitored to date
        prpc$systems_monitored_to_date_q <- reactive(paste0("SELECT COUNT(DISTINCT admin.fun_smp_to_system(d.smp_id)) FROM fieldwork.viw_deployment_full_cwl d
                                                    WHERE d.public = FALSE and deployment_dtime <= '", rv$end_date(), "'"))
        
        prpc$systems_monitored_to_date_value <- reactive(dbGetQuery(poolConn, prpc$systems_monitored_to_date_q()))
        prpc$systems_monitored_to_date <- reactive(data.frame(Metric = as.character("Systems Monitored to-Date"),
                                                              Description = "All systems at which HOBOs have been deployed",
                                                              to_date_count = prpc$systems_monitored_to_date_value()))
        
        #systems with CWL monitoring to-date-table
        #No. of public systems monitored to date
        prpc$systems_monitored_to_date_q_table <- reactive(paste0("SELECT DISTINCT admin.fun_smp_to_system(d.smp_id) FROM fieldwork.viw_deployment_full_cwl d
                                                    WHERE d.public = FALSE and deployment_dtime <= '", rv$end_date(), "'"))
        
        prpc$systems_monitored_to_date_value_table <- reactive(dbGetQuery(poolConn, prpc$systems_monitored_to_date_q_table()))
        
        #SRT pre-inspection tests this quarter
        prpc$pre_inspection_qtr_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", prpc$phase, "' AND
                                             type = 'Pre-Inspection Dye Test'", rv$quarter_range(), prpc$public_query_text))
        
        prpc$pre_inspection_qtr_value <- reactive(dbGetQuery(poolConn, prpc$pre_inspection_qtr_q()))
        
        prpc$pre_inspection_qtr <- reactive(data.frame(Metric = "Pre-Inspection Dye Tests this Quarter",
                                                       Count = prpc$pre_inspection_qtr_value()))
        
        #SRT pre-inspection tests this quarter-table
        prpc$pre_inspection_qtr_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", prpc$phase, "' AND
                                             type = 'Pre-Inspection Dye Test'", rv$quarter_range(), prpc$public_query_text))
        
        prpc$pre_inspection_qtr_value_table <- reactive(dbGetQuery(poolConn, prpc$pre_inspection_qtr_q_table()))
        
        #SRT pre-inspection tests to-date
        prpc$pre_inspection_to_date_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", prpc$phase, "' AND
                                             type = 'Pre-Inspection Dye Test'", rv$to_date_range(), prpc$public_query_text))
        
        prpc$pre_inspection_to_date_value <- reactive(dbGetQuery(poolConn, prpc$pre_inspection_to_date_q()))
        
        prpc$pre_inspection_to_date <- reactive(data.frame(Metric = "Pre-Inspection Dye Tests to-Date",
                                                           Count = prpc$pre_inspection_to_date_value()))
        
        #SRT pre-inspection tests to-date-table
        prpc$pre_inspection_to_date_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", prpc$phase, "' AND
                                             type = 'Pre-Inspection Dye Test'", rv$to_date_range(), prpc$public_query_text))
        
        prpc$pre_inspection_to_date_value_table <- reactive(dbGetQuery(poolConn, prpc$pre_inspection_to_date_q_table()))
        
        
        #SRT CCTV/ Dye Tests this quarter
        prpc$cctv_dye_test_qtr_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", prpc$phase, "' AND
                                             type = 'CCTV Dye Test'", rv$quarter_range(), prpc$public_query_text))
        
        prpc$cctv_dye_test_qtr_value <- reactive(dbGetQuery(poolConn, prpc$cctv_dye_test_qtr_q()))
        
        prpc$cctv_dye_test_qtr <- reactive(data.frame(Metric = "CCTV Dye Tests this Quarter",
                                                      Count = prpc$cctv_dye_test_qtr_value()))
        #SRT CCTV/ Dye Tests this quarter_table
        prpc$cctv_dye_test_qtr_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", prpc$phase, "' AND
                                             type = 'CCTV Dye Test'", rv$quarter_range(), prpc$public_query_text))
        
        prpc$cctv_dye_test_qtr_value_table <- reactive(dbGetQuery(poolConn, prpc$cctv_dye_test_qtr_q_table()))
        
        
        #SRT CCTV/ Dye Tests this to-date
        prpc$cctv_dye_test_to_date_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", prpc$phase, "' AND
                                             type = 'CCTV Dye Test'", rv$to_date_range(), prpc$public_query_text))
        
        prpc$cctv_dye_test_to_date_value <- reactive(dbGetQuery(poolConn, prpc$cctv_dye_test_to_date_q()))
        
        prpc$cctv_dye_test_to_date <- reactive(data.frame(Metric = "CCTV Dye Tests to-Date",
                                                          Count = prpc$cctv_dye_test_to_date_value()))
        
        #SRT CCTV/ Dye Tests this to-date-table
        prpc$cctv_dye_test_to_date_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", prpc$phase, "' AND
                                             type = 'CCTV Dye Test'", rv$to_date_range(), prpc$public_query_text))
        
        prpc$cctv_dye_test_to_date_value_table <- reactive(dbGetQuery(poolConn, prpc$cctv_dye_test_to_date_q_table()))
        
        #SRT Performance Tests this quarter
        prpc$performance_srts_qtr_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", prpc$phase, "' AND
                                             type = 'Performance Test'", rv$quarter_range(), prpc$public_query_text))
        
        prpc$performance_srts_qtr_value <- reactive(dbGetQuery(poolConn, prpc$performance_srts_qtr_q()))
        
        prpc$performance_srts_qtr <- reactive(data.frame(Metric = "Performance Tests this Quarter",
                                                         Count = prpc$performance_srts_qtr_value()))
        
        #SRT Performance Tests this quarter-table
        prpc$performance_srts_qtr_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", prpc$phase, "' AND
                                             type = 'Performance Test'", rv$quarter_range(), prpc$public_query_text))
        
        prpc$performance_srts_qtr_value_table <- reactive(dbGetQuery(poolConn, prpc$performance_srts_qtr_q_table()))
        
        #SRT Performance Tests to-date
        prpc$performance_srts_to_date_q <- reactive(paste0("SELECT COUNT(*) FROM fieldwork.viw_srt_full
                                             WHERE phase = '", prpc$phase, "' AND
                                             type = 'Performance Test'", rv$to_date_range(), prpc$public_query_text))
        
        prpc$performance_srts_to_date_value <- reactive(dbGetQuery(poolConn, prpc$performance_srts_to_date_q()))
        
        prpc$performance_srts_to_date <- reactive(data.frame(Metric = "Performance Tests to-Date",
                                                             Count = prpc$performance_srts_to_date_value()))
        
        #SRT Performance Tests to-date-table
        prpc$performance_srts_to_date_q_table <- reactive(paste0("SELECT * FROM fieldwork.viw_srt_full
                                             WHERE phase = '", prpc$phase, "' AND
                                             type = 'Performance Test'", rv$to_date_range(), prpc$public_query_text))
        
        prpc$performance_srts_to_date_value_table <- reactive(dbGetQuery(poolConn, prpc$performance_srts_to_date_q_table()))
        
        #systems with capture efficiency testing administered this quarter
        prpc$systems_tested_cet_q <- reactive(paste0("SELECT COUNT(distinct system_id) FROM fieldwork.viw_capture_efficiency_full 
            WHERE phase = '", prpc$phase, "'", rv$quarter_range(), prpc$public_query_text))
        
        prpc$systems_tested_cet_value <- reactive(dbGetQuery(poolConn, prpc$systems_tested_cet_q()))
        
        prpc$systems_tested_cet <- reactive(data.frame(Metric = "Systems with Capture Efficiency Tests this Quarter", 
                                                       Count = prpc$systems_tested_cet_value()))
        
        #systems with capture efficiency testing administered this quarter-table
        prpc$systems_tested_cet_q_table <- reactive(paste0("SELECT distinct system_id FROM fieldwork.viw_capture_efficiency_full 
            WHERE phase = '", prpc$phase, "'", rv$quarter_range(), prpc$public_query_text))
        
        prpc$systems_tested_cet_value_table <- reactive(dbGetQuery(poolConn, prpc$systems_tested_cet_q_table()))
        
        
        #systems with capture efficiency testing administered to date
        prpc$systems_tested_cet_to_date_q <- reactive(paste0("SELECT COUNT(distinct system_id) FROM fieldwork.viw_capture_efficiency_full 
            WHERE phase = '", prpc$phase, "'", rv$to_date_range(), prpc$public_query_text))
        
        prpc$systems_tested_cet_to_date_value <- reactive(dbGetQuery(poolConn, prpc$systems_tested_cet_to_date_q()))
        
        prpc$systems_tested_cet_to_date <- reactive(data.frame(Metric = "Systems with Capture Efficiency Tests to-Date", 
                                                               Count = prpc$systems_tested_cet_to_date_value()))
        
        #systems with capture efficiency testing administered to date-table
        prpc$systems_tested_cet_to_date_q_table <- reactive(paste0("SELECT distinct system_id FROM fieldwork.viw_capture_efficiency_full 
            WHERE phase = '", prpc$phase, "'", rv$to_date_range(), prpc$public_query_text))
        
        prpc$systems_tested_cet_to_date_value_table <- reactive(dbGetQuery(poolConn, prpc$systems_tested_cet_to_date_q_table()))
      }
    )
    
  }
    
        
        
  
  
  